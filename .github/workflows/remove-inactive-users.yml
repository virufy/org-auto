name: Identify and Remove Inactive Users

on:
  schedule:
    - cron: '0 0 * * 0'  # Runs weekly on Sunday at midnight
  workflow_dispatch:  # Allows manual triggering

jobs:
  identify-inactive-users:
    name: Identify Inactive Users
    runs-on: ubuntu-latest
    steps:
      - name: Analyze User Activity
        id: analyze_user_activity
        uses: peter-murray/inactive-users-action@v1
        with:
          token: ${{ secrets.ORGANIZATION_ACCESS_TOKEN }}
          organization: Virufy
          activity_days: 60

      - name: Save Report of Inactive Users
        run: |
          echo "Saving report of inactive users..."
          cp "${{ steps.analyze_user_activity.outputs.report_json }}" inactive_users.json

      - name: Add Last Active Days Column to JSON
        run: |
            echo "Adding last_active_days column..."
            jq -s '
                map(
                . + {
                    last_active_days: (
                    if .last_activity_timestamp then
                        ((now - .last_activity_timestamp) / 86400 | floor)
                    else
                        20157.95050925926  # Use the default value you provided
                    end
                    )
                }
                )
            ' inactive_users.json > updated_inactive_users.json

      - name: Debug Updated JSON File
        run: |
          echo "Contents of updated_inactive_users.json:"
          cat updated_inactive_users.json

      - name: Upload Updated Inactive Users Report
        uses: actions/upload-artifact@v4
        with:
          name: updated-inactive-users-report
          path: updated_inactive_users.json

  remove-inactive-users:
    name: Remove Inactive Users
    needs: identify-inactive-users
    runs-on: ubuntu-latest
    steps:
      - name: Download Updated Inactive Users Report
        uses: actions/download-artifact@v4
        with:
          name: updated-inactive-users-report

      - name: Create Excluded Users List from Secret (Optional)
        run: |
          echo "${{ secrets.EXCLUDED_USERS }}" > excluded_users.txt

      - name: Debug Excluded Users List (Optional)
        run: |
          echo "Contents of excluded_users.txt:"
          cat excluded_users.txt || echo "File not found or empty"

      - name: Debug JQ Output with Last Active Days Filter
        run: |
          echo "Filtered inactive users based on last_active_days:"
          jq -r '.[] | select(.last_active_days > 31 and .isActive == false) | .login' updated_inactive_users.json || echo "No matching users found"

      - name: Remove Users from Organization (Excluding Certain Users)
        run: |
          echo "Reading inactive users from report..."
          jq -r '.[] | select(.last_active_days > 31 and .isActive == false) | .login' updated_inactive_users.json | while read -r user; do
            if [ -z "$user" ]; then
              echo "No inactive users found."
              exit 0
            fi

            if grep -Fxq "$user" excluded_users.txt; then
              echo "Skipping excluded user $user"
            else
              echo "Removing user $user from organization..."
              gh api -X DELETE orgs/Virufy/members/$user || echo "Failed to remove user $user"
              echo "Removed user $user successfully."
            fi
          done || echo "No users to process"
